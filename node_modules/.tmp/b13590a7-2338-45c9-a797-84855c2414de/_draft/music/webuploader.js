/* WebUploader 0.1.0 */
(function( window, undefined ) {
    /**
     * @fileOverview 让内部各个部件的代码可以用[amd](https://github.com/amdjs/amdjs-api/wiki/AMD)模块定义方式组织起来。
     *
     * AMD API 内部的简单不完全实现，请忽略。只有当WebUploader被合并成一个文件的时候才会引入。
     */
    var internalAmd = (function( global, undefined ) {
            var modules = {},
    
                // 简单不完全实现https://github.com/amdjs/amdjs-api/wiki/require
                require = function( deps, callback ) {
                    var args, len, i;
    
                    // 如果deps不是数组，则直接返回指定module
                    if ( typeof deps === 'string' ) {
                        return getModule( deps );
                    } else {
                        args = [];
                        for( len = deps.length, i = 0; i < len; i++ ) {
                            args.push( getModule( deps[ i ] ) );
                        }
    
                        return callback.apply( null, args );
                    }
                },
    
                // 内部的define，暂时不支持不指定id.
                define = function( id, deps, factory ) {
                    if ( arguments.length === 2 ) {
                        factory = deps;
                        deps = null;
                    }
    
                    if ( typeof id !== 'string' || !factory ) {
                        throw new Error('Define Error');
                    }
    
                    require( deps || [], function() {
                        setModule( id, factory, arguments );
                    });
                },
    
                // 设置module, 兼容CommonJs写法。
                setModule = function( id, factory, args ) {
                    var module = {
                            exports: factory
                        },
                        returned;
    
                    if ( typeof factory === 'function' ) {
                        args.length || (args = [ require, module.exports, module ]);
                        returned = factory.apply( null, args );
                        returned !== undefined && (module.exports = returned);
                    }
    
                    modules[ id ] = module.exports;
                },
    
                // 根据id获取module
                getModule = function( id ) {
                    var module = modules[ id ] || global[ id ];
    
                    if ( !module ) {
                        throw new Error( '`' + id + '` is undefined' );
                    }
    
                    return module;
                };
    
            return {
                define: define,
                require: require,
    
                // 暴露所有的模块。
                modules: modules
            };
        })( window ),
    
        /* jshint unused: false */
        require = internalAmd.require,
        define = internalAmd.define;

    /**
     * @fileOverview 基础类方法。
     */
    
    /**
     * Web Uploader内部类的详细说明，以下提及的功能类，都可以在`WebUploader`这个变量中访问到。
     *
     * As you know, Web Uploader的每个文件都是用过[AMD](https://github.com/amdjs/amdjs-api/wiki/AMD)规范中的`define`组织起来的, 每个Module都会有个module id.
     * 默认module id该文件的路径，而此路径将会转化成名字空间存放在WebUploader中。如：
     *
     * * module `base`：WebUploader.Base
     * * module `file`: WebUploader.File
     * * module `lib/dnd`: WebUploader.Lib.Dnd
     * * module `runtime/html5/dnd`: WebUploader.Runtime.Html5.Dnd
     *
     *
     * 以下文档将可能省略`WebUploader`前缀。
     * @module WebUploader
     * @title WebUploader API文档
     */
    define( 'base', [
        'jQuery'
    ], function( $ ) {
    
        var noop = function() {},
            call = Function.call;
    
        // http://jsperf.com/uncurrythis
        // 反科里化
        function uncurryThis( fn ) {
            return function() {
                return call.apply( fn, arguments );
            };
        }
    
        function bindFn( fn, context ) {
            return function() {
                return fn.apply( context, arguments );
            };
        }
    
        function createObject( proto ) {
            var f;
    
            if ( Object.create ) {
                return Object.create( proto );
            } else {
                f = function() {};
                f.prototype = proto;
                return new f();
            }
        }
    
    
        /**
         * 基础类，提供一些简单常用的方法。
         * @class Base
         */
        return {
    
            /**
             * @property {String} version 当前版本号。
             */
            version: '0.1.0',
    
            /**
             * @property {jQuery|Zepto} $ 引用依赖的jQuery或者Zepto对象。
             */
            $: $,
    
            /**
             * 创建一个[Deferred](http://api.jquery.com/category/deferred-object/)对象。
             * 详细的Deferred用法说明，请参照jQuery的API文档。
             *
             * Deferred对象在钩子回掉函数中经常要用到，用来处理需要等待的异步操作。
             *
             *
             * @method Deferred
             * @grammar Base.Deferred() => Deferred
             * @example
             * // 在文件开始发送前做些异步操作。
             * // WebUploader会等待此异步操作完成后，开始发送文件。
             * Uploader.register({
             *     'before-send-file': 'doSomthingAsync'
             * }, {
             *
             *     doSomthingAsync: function() {
             *         var deferred = Base.Deferred();
             *
             *         // 模拟一次异步操作。
             *         setTimeout(deferred.resolve, 2000);
             *
             *         return deferred.promise();
             *     }
             * });
             */
            Deferred: $.Deferred,
    
            /**
             * 判断传入的参数是否为一个promise对象。
             * @method isPromise
             * @grammar Base.isPromise( anything ) => Boolean
             * @param  {*}  anything 检测对象。
             * @return {Boolean}
             * @example
             * console.log( Base.isPromise() );    // => false
             * console.log( Base.isPromise({ key: '123' }) );    // => false
             * console.log( Base.isPromise( Base.Deferred().promise() ) );    // => true
             *
             * // Deferred也是一个Promise
             * console.log( Base.isPromise( Base.Deferred() ) );    // => true
             */
            isPromise: function( anything ) {
                return anything && typeof anything.then === 'function';
            },
    
    
            /**
             * 返回一个promise，此promise在所有传入的promise都完成了